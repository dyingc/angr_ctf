#!/usr/bin/env python3
"""
æ·±å…¥ç†è§£angrä¸­ASTçš„å¯„å­˜å™¨å’Œå†…å­˜å­˜å‚¨æœºåˆ¶
============================================

æœ¬æ•™ç¨‹æ¼”ç¤ºäº†angrä¸­ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š"any bitvector-typed AST can be stored in registers or memory"
ï¼ˆä»»ä½•ä½å‘é‡ç±»å‹çš„ASTéƒ½å¯ä»¥å­˜å‚¨åœ¨å¯„å­˜å™¨æˆ–å†…å­˜ä¸­ï¼‰ã€‚

å‰ç½®çŸ¥è¯†ï¼š
- å¯¹äºŒè¿›åˆ¶ç¨‹åºæœ‰åŸºæœ¬äº†è§£ï¼ˆå¯„å­˜å™¨ã€å†…å­˜æ¦‚å¿µï¼‰
- äº†è§£ç¬¦å·æ‰§è¡Œçš„åŸºæœ¬æ¦‚å¿µï¼ˆæ¨èå…ˆå®Œæˆangr CTFçš„00-02æŒ‘æˆ˜ï¼‰

å­¦ä¹ ç›®æ ‡ï¼š
1. ç†è§£ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰åœ¨ç¬¦å·æ‰§è¡Œä¸­çš„ä½œç”¨
2. æŒæ¡ASTçš„æ ‘çŠ¶ç»“æ„ï¼Œäº†è§£å¦‚ä½•æ„å»ºå¤æ‚çš„ç¬¦å·è¡¨è¾¾å¼
3. å­¦ä¼šå°†ASTå­˜å‚¨åˆ°ä¸åŒä½ç½®ï¼ˆå¯„å­˜å™¨ã€å†…å­˜ï¼‰å¹¶ç†è§£å…¶ç­‰ä»·æ€§
4. æŒæ¡å¯¹å­˜å‚¨çš„ASTè¿›è¡Œæ“ä½œå’Œçº¦æŸæ±‚è§£çš„æ–¹æ³•
5. ç†è§£ç¬¦å·æ‰§è¡Œå¦‚ä½•è·Ÿè¸ªç¨‹åºä¸­çš„å¤æ‚æ•°æ®æµ

ç›¸å…³æ–‡æ¡£ï¼š
- angr ASTæ¦‚å¿µï¼šhttps://docs.angr.io/en/latest/core-concepts/solver.html#working-with-bitvectors
- claripy ASTæ“ä½œï¼šhttps://docs.angr.io/en/latest/advanced-topics/claripy.html#claripy-asts

ä½¿ç”¨æ–¹æ³•ï¼š
ç›´æ¥è¿è¡Œæ­¤è„šæœ¬ï¼Œè§‚å¯Ÿæ¯ä¸ªæ¼”ç¤ºéƒ¨åˆ†çš„è¾“å‡ºï¼Œç†è§£ASTåœ¨ä¸åŒåœºæ™¯ä¸‹çš„è¡Œä¸ºã€‚

ä»€ä¹ˆæ˜¯ASTï¼Ÿ
ASTï¼ˆAbstract Syntax Treeï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼‰æ˜¯angrä¸­è¡¨ç¤ºç¬¦å·è¡¨è¾¾å¼çš„æ•°æ®ç»“æ„ã€‚
å®ƒä¸æ˜¯å…·ä½“çš„æ•°å€¼ï¼Œè€Œæ˜¯å¯¹è®¡ç®—çš„æè¿°ï¼Œä¾‹å¦‚ï¼š
- å…·ä½“å€¼ï¼š0x1000ï¼ˆä¸€ä¸ªå›ºå®šçš„æ•°å­—ï¼‰
- ç¬¦å·å€¼ï¼šxï¼ˆä¸€ä¸ªæœªçŸ¥çš„å˜é‡ï¼‰
- å¤åˆè¡¨è¾¾å¼ï¼š(x + 10) * 2ï¼ˆä¸€ä¸ªè®¡ç®—è¿‡ç¨‹ï¼‰

åœ¨ç¬¦å·æ‰§è¡Œä¸­ï¼ŒASTè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸çŸ¥é“å…·ä½“è¾“å…¥çš„æƒ…å†µä¸‹ï¼Œè·Ÿè¸ªç¨‹åºçš„æ‰€æœ‰å¯èƒ½è®¡ç®—è·¯å¾„ã€‚
"""

import warnings
warnings.filterwarnings("ignore", message="pkg_resources is deprecated")

import angr
import claripy

def demonstrate_ast_tree_structure():
    """æ¼”ç¤ºASTçš„æ ‘çŠ¶ç»“æ„"""
    print("=== ASTæ ‘çŠ¶ç»“æ„åˆ†æ ===")
    print()

    # åˆ›å»ºç¬¦å·å˜é‡ - è¿™äº›ä»£è¡¨æœªçŸ¥çš„è¾“å…¥å€¼
    # BVS = BitVector Symbolï¼ˆç¬¦å·ä½å‘é‡ï¼‰ï¼Œ32ä½å®½åº¦
    x = claripy.BVS("x", 32)  # ç¬¦å·å˜é‡xï¼Œä»£è¡¨ä¸€ä¸ª32ä½çš„æœªçŸ¥å€¼
    y = claripy.BVS("y", 32)  # ç¬¦å·å˜é‡yï¼Œä»£è¡¨å¦ä¸€ä¸ª32ä½çš„æœªçŸ¥å€¼

    print(f"åˆ›å»ºçš„ç¬¦å·å˜é‡:")
    print(f"  x = {x} (32ä½ç¬¦å·å˜é‡)")
    print(f"  y = {y} (32ä½ç¬¦å·å˜é‡)")
    print()

    # æ„å»ºå¤æ‚çš„ASTè¡¨è¾¾å¼
    # æ³¨æ„ï¼šè¿™é‡Œä¸ä¼šè¿›è¡Œå®é™…è®¡ç®—ï¼Œè€Œæ˜¯æ„å»ºä¸€ä¸ªæè¿°è®¡ç®—è¿‡ç¨‹çš„æ ‘ç»“æ„
    expr = (x + 10) * (y - 5) + 0x100

    print(f"æ„å»ºçš„å¤æ‚è¡¨è¾¾å¼: {expr}")
    print(f"è¿™ä¸ªè¡¨è¾¾å¼ä»£è¡¨çš„æ•°å­¦è®¡ç®—: (x + 10) * (y - 5) + 256")
    print(f"æ ¹èŠ‚ç‚¹æ“ä½œç±»å‹: {expr.op} (æœ€å¤–å±‚çš„æ“ä½œ)")
    print()

    def print_ast_tree(node, depth=0):
        """é€’å½’æ‰“å°ASTæ ‘ç»“æ„

        å‚æ•°:
        - node: å½“å‰è¦åˆ†æçš„ASTèŠ‚ç‚¹
        - depth: å½“å‰åœ¨æ ‘ä¸­çš„æ·±åº¦ï¼Œç”¨äºç¼©è¿›æ˜¾ç¤º

        è¿™ä¸ªå‡½æ•°ä¼šé€’å½’éå†æ•´ä¸ªASTæ ‘ï¼Œæ˜¾ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ“ä½œç±»å‹å’Œå‚æ•°ã€‚
        """
        indent = "  " * depth  # æ ¹æ®æ·±åº¦åˆ›å»ºç¼©è¿›
        print(f"{indent}â”œâ”€ æ“ä½œç±»å‹: {node.op}")

        # å¸¸è§çš„ASTæ“ä½œç±»å‹è§£é‡Šï¼š
        # - 'BVS': ç¬¦å·å˜é‡ (BitVector Symbol)
        # - 'BVV': å…·ä½“å€¼ (BitVector Value)
        # - '__add__': åŠ æ³•æ“ä½œ
        # - '__sub__': å‡æ³•æ“ä½œ
        # - '__mul__': ä¹˜æ³•æ“ä½œ

        if hasattr(node, 'args') and node.args:
            print(f"{indent}â”œâ”€ å‚æ•°æ•°é‡: {len(node.args)}")
            for i, arg in enumerate(node.args):
                print(f"{indent}â”œâ”€ å‚æ•° {i}:")
                if hasattr(arg, 'op'):
                    # å¦‚æœå‚æ•°è¿˜æœ‰æ“ä½œç¬¦ï¼Œè¯´æ˜å®ƒæ˜¯å­æ ‘ï¼Œé€’å½’å¤„ç†
                    print_ast_tree(arg, depth + 1)
                else:
                    # å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼ˆå¸¸é‡å€¼ï¼‰ï¼Œç›´æ¥æ˜¾ç¤º
                    print(f"{indent}   â””â”€ å…·ä½“å€¼: {arg}")
        print()

    print("ASTæ ‘ç»“æ„å¯è§†åŒ– (ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹):")
    print("æ¯ä¸ªèŠ‚ç‚¹æ˜¾ç¤ºå…¶æ“ä½œç±»å‹ï¼Œå¶å­èŠ‚ç‚¹æ˜¯å˜é‡æˆ–å¸¸é‡")
    print("-" * 50)
    print_ast_tree(expr)

    print("æ ‘ç»“æ„è§£è¯»:")
    print("- æœ€é¡¶å±‚æ˜¯åŠ æ³•æ“ä½œ (+ 0x100)")
    print("- ç¬¬äºŒå±‚æ˜¯ä¹˜æ³•æ“ä½œ (*)")
    print("- ç¬¬ä¸‰å±‚æ˜¯ä¸¤ä¸ªåŠ æ³•æ“ä½œ (x + 10) å’Œ (y - 5)")
    print("- å¶å­èŠ‚ç‚¹æ˜¯ç¬¦å·å˜é‡xã€yå’Œå¸¸é‡10ã€5ã€0x100")

def demonstrate_storage_equivalence():
    """æ¼”ç¤ºASTåœ¨ä¸åŒå­˜å‚¨ä½ç½®çš„ç­‰ä»·æ€§

    è¿™ä¸ªå‡½æ•°æ¼”ç¤ºäº†angrçš„æ ¸å¿ƒæ¦‚å¿µï¼šä»»ä½•bitvectorç±»å‹çš„ASTéƒ½å¯ä»¥å­˜å‚¨åœ¨å¯„å­˜å™¨ï¼ˆå¦‚EAXã€EBXç­‰ï¼‰æˆ–å†…å­˜ï¼ˆé€šè¿‡åœ°å€è®¿é—®ï¼‰ä¸­ã€‚
    ç†è§£è¿™ä¸ªæ¦‚å¿µå¯¹äºç¬¦å·æ‰§è¡Œè‡³å…³é‡è¦ï¼Œå› ä¸ºï¼š

    1. çµæ´»æ€§ï¼šåŒä¸€ä¸ªASTå¯ä»¥åœ¨ä¸åŒåœ°æ–¹ä½¿ç”¨ï¼Œå°±åƒç¨‹åºä¸­çš„å˜é‡
    2. ä¸€è‡´æ€§ï¼šå­˜å‚¨ä½ç½®ä¸æ”¹å˜ASTçš„ç¬¦å·å«ä¹‰
    3. å¯è¿½è¸ªæ€§ï¼šangrå¯ä»¥è·Ÿè¸ªASTåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æµåŠ¨
    """
    print("=== ASTå­˜å‚¨ç­‰ä»·æ€§æ¼”ç¤º ===")
    print("æ¼”ç¤ºï¼šåŒä¸€ä¸ªASTå¯ä»¥å­˜å‚¨åœ¨å¯„å­˜å™¨æˆ–å†…å­˜ä¸­ï¼Œä¸”ä¿æŒç›¸åŒå«ä¹‰")
    print()

    # åˆ›å»ºä¸€ä¸ªangré¡¹ç›®å®ä¾‹ï¼Œç”¨äºæ¨¡æ‹Ÿç¨‹åºæ‰§è¡Œç¯å¢ƒ
    proj = angr.Project('/bin/ls')
    state = proj.factory.entry_state()

    print("ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸åŒç±»å‹çš„AST")
    print("-" * 40)

    # åˆ›å»ºå„ç§ç±»å‹çš„ASTæ¥æ¼”ç¤ºå­˜å‚¨æœºåˆ¶ï¼š

    # 1. å…·ä½“å€¼AST - ä»£è¡¨ä¸€ä¸ªå·²çŸ¥çš„å›ºå®šå€¼
    # ä¸‹è¿° BVV å¯¹è±¡å…·æœ‰32ä½å®½åº¦ï¼Œå€¼ä¸º0xdeadbeef
    concrete_ast = claripy.BVV(0xdeadbeef, 32)

    # 2. ç¬¦å·AST - ä»£è¡¨ä¸€ä¸ªæœªçŸ¥çš„è¾“å…¥å€¼
    # ä¸‹è¿° BVS å¯¹è±¡å…·æœ‰32ä½å®½åº¦ï¼Œåç§°ä¸º"input"
    symbolic_ast = claripy.BVS("input", 32)

    # 3. å¤åˆAST - ç”±å…¶ä»–ASTç»„åˆè€Œæˆçš„å¤æ‚è¡¨è¾¾å¼
    # è¿™ä»£è¡¨ï¼š(input * 2) + 0xdeadbeef çš„è®¡ç®—è¿‡ç¨‹
    complex_ast = symbolic_ast * 2 + concrete_ast

    print("1. åŸå§‹ASTç±»å‹:")
    print(f"   å…·ä½“å€¼AST: {concrete_ast}")
    print(f"     â””â”€ ç±»å‹ï¼šBitVector Valueï¼Œè¡¨ç¤ºå›ºå®šæ•°å€¼ 0xdeadbeef")
    print(f"   ç¬¦å·AST: {symbolic_ast}")
    print(f"     â””â”€ ç±»å‹ï¼šBitVector Symbolï¼Œè¡¨ç¤ºæœªçŸ¥å˜é‡ 'input'")
    print(f"   å¤åˆAST: {complex_ast}")
    print(f"     â””â”€ ç±»å‹ï¼šå¤åˆè¡¨è¾¾å¼ï¼Œè¡¨ç¤º (input * 2) + 0xdeadbeef")
    print()

    print("ç¬¬äºŒæ­¥ï¼šå°†ASTå­˜å‚¨åˆ°å¯„å­˜å™¨")
    print("-" * 40)
    print("å¯„å­˜å™¨æ˜¯CPUä¸­çš„é«˜é€Ÿå­˜å‚¨å•å…ƒï¼Œç¨‹åºé€šè¿‡å¯„å­˜å™¨è¿›è¡Œè®¡ç®—")
    print()

    # å°†ä¸åŒç±»å‹çš„ASTåˆ†åˆ«å­˜å‚¨åˆ°ä¸åŒçš„å¯„å­˜å™¨
    state.regs.eax = concrete_ast  # å°†å…·ä½“å€¼å­˜å‚¨åˆ°EAXå¯„å­˜å™¨
    state.regs.ebx = symbolic_ast  # å°†ç¬¦å·å˜é‡å­˜å‚¨åˆ°EBXå¯„å­˜å™¨
    state.regs.ecx = complex_ast  # å°†å¤åˆè¡¨è¾¾å¼å­˜å‚¨åˆ°ECXå¯„å­˜å™¨

    print("å­˜å‚¨æ“ä½œå®Œæˆï¼š")
    print(f"   EAX â† {concrete_ast}")
    print(f"   EBX â† {symbolic_ast}")
    print(f"   ECX â† {complex_ast}")
    print()

    print("éªŒè¯å¯„å­˜å™¨ä¸­çš„ASTï¼š")
    print(f"   EAXä¸­çš„AST: {state.regs.eax}")
    print(f"   EBXä¸­çš„AST: {state.regs.ebx}")
    print(f"   ECXä¸­çš„AST: {state.regs.ecx}")
    print("   æ³¨æ„ï¼šå¯„å­˜å™¨ä¸­çš„ASTä¿æŒäº†åŸå§‹çš„ç¬¦å·å«ä¹‰ï¼")
    print()

    print("ç¬¬ä¸‰æ­¥ï¼šå°†ASTå­˜å‚¨åˆ°å†…å­˜")
    print("-" * 40)
    print("å†…å­˜æ˜¯RAMä¸­çš„å­˜å‚¨åŒºåŸŸï¼Œé€šè¿‡åœ°å€è®¿é—®ï¼Œç”¨äºæŒä¹…å­˜å‚¨æ•°æ®")
    print()

    # å®šä¹‰å†…å­˜åœ°å€ - é€‰æ‹©ä¸€ä¸ªè¾ƒé«˜çš„åœ°å€é¿å…ä¸ç¨‹åºä»£ç å†²çª
    addr1, addr2, addr3 = 0x10000, 0x10004, 0x10008  # æ¯ä¸ª32ä½å€¼å ç”¨4å­—èŠ‚

    print(f"é€‰æ‹©çš„å†…å­˜åœ°å€ï¼š")
    print(f"   addr1 = 0x{addr1:x} (ç¬¬ä¸€ä¸ª32ä½å€¼)")
    print(f"   addr2 = 0x{addr2:x} (ç¬¬äºŒä¸ª32ä½å€¼)")
    print(f"   addr3 = 0x{addr3:x} (ç¬¬ä¸‰ä¸ª32ä½å€¼)")
    print()

    # å°†ASTå­˜å‚¨åˆ°å†…å­˜çš„ä¸åŒä½ç½®
    # state.mem[address].uint32_t = ast çš„å«ä¹‰æ˜¯ï¼š
    # - åœ¨æŒ‡å®šåœ°å€å­˜å‚¨ä¸€ä¸ª32ä½æ— ç¬¦å·æ•´æ•°
    # - è¿™ä¸ªæ•´æ•°çš„å€¼ç”±ASTæè¿°ï¼ˆå¯èƒ½æ˜¯ç¬¦å·çš„ï¼‰
    state.mem[addr1].uint32_t = concrete_ast
    state.mem[addr2].uint32_t = symbolic_ast
    state.mem[addr3].uint32_t = complex_ast

    print("å­˜å‚¨æ“ä½œå®Œæˆï¼š")
    print(f"   å†…å­˜[0x{addr1:x}] â† {concrete_ast}")
    print(f"   å†…å­˜[0x{addr2:x}] â† {symbolic_ast}")
    print(f"   å†…å­˜[0x{addr3:x}] â† {complex_ast}")
    print()

    print("éªŒè¯å†…å­˜ä¸­çš„ASTï¼š")
    print(f"   å†…å­˜[0x{addr1:x}]: {state.mem[addr1].uint32_t.resolved}")
    print(f"   å†…å­˜[0x{addr2:x}]: {state.mem[addr2].uint32_t.resolved}")
    print(f"   å†…å­˜[0x{addr3:x}]: {state.mem[addr3].uint32_t.resolved}")
    print("   æ³¨æ„ï¼š.resolved ç”¨äºè·å–å†…å­˜ä½ç½®ä¸­çš„ASTå¯¹è±¡")
    print()

    print("ç¬¬å››æ­¥ï¼šéªŒè¯å­˜å‚¨ç­‰ä»·æ€§")
    print("-" * 40)
    print("ç°åœ¨æˆ‘ä»¬éªŒè¯ï¼šæ— è®ºASTå­˜å‚¨åœ¨å“ªé‡Œï¼Œå®ƒéƒ½ä¿æŒç›¸åŒçš„ç¬¦å·å«ä¹‰")
    print()

    # ä»å¯„å­˜å™¨å’Œå†…å­˜è¯»å–åŒä¸€ä¸ªASTï¼Œå¹¶æ¯”è¾ƒå®ƒä»¬æ˜¯å¦ç­‰ä»·
    eax_value = state.regs.eax  # ä»EAXå¯„å­˜å™¨è¯»å–
    mem_value = state.mem[addr1].uint32_t.resolved  # ä»å†…å­˜åœ°å€0x10000è¯»å–

    print("æ¯”è¾ƒæ“ä½œï¼š")
    print(f"   ä»EAXè¯»å–: {eax_value}")
    print(f"   ä»å†…å­˜è¯»å–: {mem_value}")
    print()

    # ä½¿ç”¨ä¸¤ç§æ–¹å¼éªŒè¯ç­‰ä»·æ€§ï¼š
    # 1. å¯¹è±¡èº«ä»½æ£€æŸ¥ (is) - æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡
    # 2. å­—ç¬¦ä¸²è¡¨ç¤ºæ¯”è¾ƒ - æ£€æŸ¥ASTç»“æ„æ˜¯å¦ç›¸åŒ
    print("ç­‰ä»·æ€§éªŒè¯ç»“æœï¼š")
    print(f"   EAX == å†…å­˜[0x{addr1:x}] (å¯¹è±¡èº«ä»½): {eax_value is concrete_ast}")
    print(f"   ASTç»“æ„ç›¸åŒ (å­—ç¬¦ä¸²æ¯”è¾ƒ): {str(eax_value) == str(mem_value)}")
    print()

    print("å…³é”®ç»“è®ºï¼š")
    print("âœ“ ASTå¯ä»¥è‡ªç”±åœ°åœ¨å¯„å­˜å™¨å’Œå†…å­˜ä¹‹é—´ç§»åŠ¨")
    print("âœ“ å­˜å‚¨ä½ç½®ä¸ä¼šæ”¹å˜ASTçš„ç¬¦å·å«ä¹‰")
    print("âœ“ è¿™ä½¿å¾—ç¬¦å·æ‰§è¡Œèƒ½å¤Ÿå‡†ç¡®è·Ÿè¸ªç¨‹åºä¸­çš„æ•°æ®æµåŠ¨")

def demonstrate_ast_operations_storage():
    """æ¼”ç¤ºå¯¹å­˜å‚¨çš„ASTè¿›è¡Œæ“ä½œ

    è¿™ä¸ªå‡½æ•°å±•ç¤ºäº†å¦‚ä½•åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹å­˜å‚¨çš„ASTè¿›è¡Œæ“ä½œï¼Œ
    è¿™æ¨¡æ‹Ÿäº†çœŸå®ç¨‹åºä¸­æ•°æ®å¤„ç†çš„è¿‡ç¨‹ã€‚

    å…³é”®æ¦‚å¿µï¼š
    1. æ•°æ®æµåŠ¨ï¼šASTå¦‚ä½•åœ¨å†…å­˜å’Œå¯„å­˜å™¨ä¹‹é—´ç§»åŠ¨
    2. æ¸è¿›å¼å¤„ç†ï¼šå¦‚ä½•é€æ­¥æ„å»ºå¤æ‚çš„ç¬¦å·è¡¨è¾¾å¼
    3. æ“ä½œé“¾ï¼šä¸€ç³»åˆ—æ“ä½œå¦‚ä½•å½¢æˆä¸€ä¸ªå®Œæ•´çš„è®¡ç®—é“¾

    å®é™…åº”ç”¨åœºæ™¯ï¼š
    - è·Ÿè¸ªç”¨æˆ·è¾“å…¥åœ¨ç¨‹åºä¸­çš„å¤„ç†è¿‡ç¨‹
    - åˆ†æåŠ å¯†ç®—æ³•çš„æ¯ä¸€æ­¥å˜æ¢
    - ç†è§£æ•°æ®éªŒè¯å’Œæ£€æŸ¥é€»è¾‘
    """
    print("\n=== å¯¹å­˜å‚¨çš„ASTè¿›è¡Œæ“ä½œ ===")
    print("æ¼”ç¤ºï¼šæ¨¡æ‹Ÿç¨‹åºä¸­æ•°æ®çš„é€æ­¥å¤„ç†è¿‡ç¨‹")
    print()

    # åˆ›å»ºangré¡¹ç›®å®ä¾‹
    proj = angr.Project('/bin/ls')
    state = proj.factory.entry_state()

    print("åœºæ™¯è®¾å®šï¼šæ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„æ•°æ®å¤„ç†ç¨‹åº")
    print("ç¨‹åºæµç¨‹ï¼šè¾“å…¥ â†’ åŠ å€ â†’ åŠ åç§» â†’ æŒ‰ä½å–å â†’ è¾“å‡º")
    print()

    # ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç¬¦å·è¾“å…¥ï¼Œä»£è¡¨ç”¨æˆ·çš„åŸå§‹è¾“å…¥
    # è¿™æ¨¡æ‹Ÿäº†ç¨‹åºä»ç”¨æˆ·æˆ–æ–‡ä»¶è¯»å–è¾“å…¥çš„æƒ…å†µ
    user_input = claripy.BVS("user_input", 32)
    print(f"ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç¬¦å·è¾“å…¥")
    print(f"  ç”¨æˆ·è¾“å…¥: {user_input}")
    print(f"  è¯´æ˜ï¼šè¿™ä»£è¡¨ä¸€ä¸ªæœªçŸ¥çš„32ä½ç”¨æˆ·è¾“å…¥å€¼")
    print()

    # ç¬¬äºŒæ­¥ï¼šå°†è¾“å…¥å­˜å‚¨åˆ°å†…å­˜ï¼Œæ¨¡æ‹Ÿç¨‹åºå°†è¾“å…¥è¯»å…¥ç¼“å†²åŒº
    input_addr = 0x20000  # æ¨¡æ‹Ÿè¾“å…¥ç¼“å†²åŒºçš„åœ°å€
    state.mem[input_addr].uint32_t = user_input
    print(f"ç¬¬äºŒæ­¥ï¼šå­˜å‚¨è¾“å…¥åˆ°å†…å­˜ç¼“å†²åŒº")
    print(f"  æ“ä½œ: å†…å­˜[0x{input_addr:x}] â† {user_input}")
    print(f"  éªŒè¯: {state.mem[input_addr].uint32_t.resolved}")
    print(f"  è¯´æ˜ï¼šæ¨¡æ‹Ÿç¨‹åºå°†ç”¨æˆ·è¾“å…¥ä¿å­˜åˆ°å†…å­˜ç¼“å†²åŒº")
    print()

    # ç¬¬ä¸‰æ­¥ï¼šä»å†…å­˜è¯»å–å¹¶å¤„ç†ç¬¬ä¸€å±‚æ“ä½œ
    # è¿™æ¨¡æ‹Ÿäº†ç¨‹åºå¯¹è¾“å…¥è¿›è¡Œç¬¬ä¸€æ¬¡å¤„ç†
    loaded_value = state.mem[input_addr].uint32_t.resolved
    processed_value = loaded_value * 2 + 0x100  # åŠ å€ååŠ 256

    print(f"ç¬¬ä¸‰æ­¥ï¼šç¬¬ä¸€æ¬¡æ•°æ®å¤„ç†")
    print(f"  æ“ä½œ: ä»å†…å­˜è¯»å– â†’ åŠ å€ â†’ åŠ åç§»")
    print(f"  è®¡ç®—: ({loaded_value}) * 2 + 0x100")
    print(f"  ç»“æœ: {processed_value}")
    print(f"  è¯´æ˜ï¼šè¿™æ˜¯ç¨‹åºçš„ç¬¬ä¸€ä¸ªå¤„ç†é˜¶æ®µ")
    print()

    # ç¬¬å››æ­¥ï¼šå­˜å‚¨ä¸­é—´ç»“æœï¼Œæ¨¡æ‹Ÿç¨‹åºçš„ä¸­é—´å¤„ç†æ­¥éª¤
    result_addr = 0x20004  # æ¨¡æ‹Ÿä¸­é—´ç»“æœç¼“å†²åŒº
    state.mem[result_addr].uint32_t = processed_value
    print(f"ç¬¬å››æ­¥ï¼šå­˜å‚¨ä¸­é—´ç»“æœ")
    print(f"  æ“ä½œ: å†…å­˜[0x{result_addr:x}] â† {processed_value}")
    print(f"  éªŒè¯: {state.mem[result_addr].uint32_t.resolved}")
    print(f"  è¯´æ˜ï¼šç¨‹åºä¿å­˜ç¬¬ä¸€é˜¶æ®µçš„å¤„ç†ç»“æœ")
    print()

    # ç¬¬äº”æ­¥ï¼šæœ€ç»ˆå¤„ç†æ­¥éª¤ï¼Œå°†ç»“æœå­˜å‚¨åˆ°å¯„å­˜å™¨
    # è¿™æ¨¡æ‹Ÿäº†ç¨‹åºçš„æœ€ç»ˆå¤„ç†å’Œè¿”å›å€¼å‡†å¤‡
    intermediate_result = state.mem[result_addr].uint32_t.resolved
    final_result = intermediate_result ^ 0xffffffff  # æŒ‰ä½å¼‚æˆ–å–å
    state.regs.eax = final_result  # EAXé€šå¸¸ç”¨ä½œå‡½æ•°è¿”å›å€¼

    print(f"ç¬¬äº”æ­¥ï¼šæœ€ç»ˆå¤„ç†")
    print(f"  æ“ä½œ: æŒ‰ä½å¼‚æˆ–å–å â†’ å­˜å‚¨åˆ°EAXå¯„å­˜å™¨")
    print(f"  è®¡ç®—: {intermediate_result} ^ 0xffffffff")
    print(f"  ç»“æœ: {final_result}")
    print(f"  ä½ç½®: EAXå¯„å­˜å™¨ (å‡½æ•°è¿”å›å€¼)")
    print(f"  è¯´æ˜ï¼šç¨‹åºçš„æœ€ç»ˆå¤„ç†æ­¥éª¤ï¼Œå‡†å¤‡è¿”å›ç»“æœ")
    print()

    # ç¬¬å…­æ­¥ï¼šæ˜¾ç¤ºå®Œæ•´çš„ASTè½¬æ¢é“¾
    print("ç¬¬å…­æ­¥ï¼šå®Œæ•´çš„æ•°æ®å¤„ç†é“¾åˆ†æ")
    print("-" * 50)
    print(f"åŸå§‹è¾“å…¥:     {user_input}")
    print(f"ç¬¬ä¸€æ¬¡å¤„ç†:   ({user_input}) * 2 + 0x100")
    print(f"æœ€ç»ˆç»“æœ:     (({user_input}) * 2 + 0x100) ^ 0xffffffff")
    print()

    print("å…³é”®è§‚å¯Ÿç‚¹ï¼š")
    print("1. ASTå§‹ç»ˆä¿æŒç¬¦å·æ€§ - æ²¡æœ‰ä¸¢å¤±ä»»ä½•ä¿¡æ¯")
    print("2. æ¯ä¸€æ­¥æ“ä½œéƒ½æ‰©å±•äº†ASTçš„å¤æ‚åº¦")
    print("3. æœ€ç»ˆçš„EAXåŒ…å«äº†å®Œæ•´çš„å¤„ç†å†å²")
    print("4. è¿™ä¸ªASTä»£è¡¨äº†æ‰€æœ‰å¯èƒ½è¾“å…¥çš„å®Œæ•´å¤„ç†è¿‡ç¨‹")
    print()

    print("å®é™…åº”ç”¨ä»·å€¼ï¼š")
    print("âœ“ å¯ä»¥åˆ†æç¨‹åºå¯¹ä»»æ„è¾“å…¥çš„å¤„ç†æ–¹å¼")
    print("âœ“ èƒ½å¤Ÿé€†å‘æ¨å¯¼éœ€è¦ä»€ä¹ˆæ ·çš„è¾“å…¥æ‰èƒ½å¾—åˆ°ç‰¹å®šè¾“å‡º")
    print("âœ“ å¸®åŠ©ç†è§£ç¨‹åºçš„ç®—æ³•é€»è¾‘å’Œæ•°æ®æµ")
    print("âœ“ æ”¯æŒè‡ªåŠ¨åŒ–çš„æ¼æ´åˆ†æå’Œè¾“å…¥ç”Ÿæˆ")

def demonstrate_constraint_solving():
    """æ¼”ç¤ºçº¦æŸæ±‚è§£ä¸AST

    è¿™ä¸ªå‡½æ•°å±•ç¤ºäº†ç¬¦å·æ‰§è¡Œæœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€ï¼šçº¦æŸæ±‚è§£ã€‚
    é€šè¿‡çº¦æŸæ±‚è§£ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
    1. åå‘æ¨å¯¼ï¼šçŸ¥é“æœŸæœ›çš„è¾“å‡ºï¼Œæ‰¾å‡ºéœ€è¦çš„è¾“å…¥
    2. è·¯å¾„æ¢ç´¢ï¼šæ‰¾åˆ°èƒ½å¤Ÿåˆ°è¾¾ç‰¹å®šä»£ç è·¯å¾„çš„è¾“å…¥
    3. æ¼æ´åˆ†æï¼šç¡®å®šè§¦å‘æ¼æ´çš„å…·ä½“è¾“å…¥å€¼

    çº¦æŸæ±‚è§£çš„æ ¸å¿ƒæ¦‚å¿µï¼š
    - ç¬¦å·å˜é‡ï¼šä»£è¡¨æœªçŸ¥è¾“å…¥
    - çº¦æŸæ¡ä»¶ï¼šæè¿°å˜é‡å¿…é¡»æ»¡è¶³çš„å…³ç³»
    - æ±‚è§£å™¨ï¼šæ‰¾åˆ°æ»¡è¶³æ‰€æœ‰çº¦æŸçš„å…·ä½“å€¼

    å®é™…åº”ç”¨ï¼š
    - å¯†ç ç ´è§£ï¼šæ‰¾åˆ°æ­£ç¡®çš„å¯†ç 
    - è¾“å…¥ç”Ÿæˆï¼šåˆ›å»ºè§¦å‘ç‰¹å®šè¡Œä¸ºçš„æµ‹è¯•ç”¨ä¾‹
    - æ¼æ´åˆ©ç”¨ï¼šç”Ÿæˆèƒ½å¤Ÿåˆ©ç”¨æ¼æ´çš„è¾“å…¥
    """
    print("\n=== çº¦æŸæ±‚è§£ä¸AST ===")
    print("æ¼”ç¤ºï¼šä»æœŸæœ›çš„è¾“å‡ºåå‘æ¨å¯¼æ‰€éœ€çš„è¾“å…¥")
    print()

    # åˆ›å»ºangré¡¹ç›®å®ä¾‹
    proj = angr.Project('/bin/ls')
    state = proj.factory.entry_state()

    print("åœºæ™¯è®¾å®šï¼šæ¨¡æ‹Ÿä¸€ä¸ªå¯†ç éªŒè¯ç¨‹åº")
    print("ç¨‹åºé€»è¾‘ï¼šæ£€æŸ¥å¯†ç æ˜¯å¦æ»¡è¶³ç‰¹å®šæ¡ä»¶")
    print("éªŒè¯å…¬å¼ï¼špassword * 1337 + 42 == 0x13371337")
    print()

    # ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç¬¦å·å˜é‡ï¼Œä»£è¡¨æœªçŸ¥çš„å¯†ç è¾“å…¥
    password = claripy.BVS("password", 32)
    print(f"ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç¬¦å·å˜é‡")
    print(f"  å¯†ç å˜é‡: {password}")
    print(f"  è¯´æ˜ï¼šè¿™æ˜¯ä¸€ä¸ª32ä½çš„æœªçŸ¥è¾“å…¥ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®ƒçš„æ­£ç¡®å€¼")
    print()

    # ç¬¬äºŒæ­¥ï¼šæ„å»ºå¯†ç æ£€æŸ¥çš„è¡¨è¾¾å¼
    # è¿™æ¨¡æ‹Ÿäº†ç¨‹åºä¸­å¯¹å¯†ç çš„å¤„ç†é€»è¾‘
    check_expr = password * 1337 + 42
    target_value = 0x13371337

    print(f"ç¬¬äºŒæ­¥ï¼šæ„å»ºå¯†ç éªŒè¯é€»è¾‘")
    print(f"  éªŒè¯è¡¨è¾¾å¼: {check_expr}")
    print(f"  ç›®æ ‡å€¼: 0x{target_value:x}")
    print(f"  å®Œæ•´æ¡ä»¶: {check_expr} == 0x{target_value:x}")
    print(f"  è¯´æ˜ï¼šç¨‹åºè®¡ç®— password * 1337 + 42ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦ç­‰äºç›®æ ‡å€¼")
    print()

    # ç¬¬ä¸‰æ­¥ï¼šå°†ASTå­˜å‚¨åˆ°å¯„å­˜å™¨ï¼Œæ¨¡æ‹Ÿç¨‹åºçš„å®é™…æ‰§è¡Œ
    # è¿™å±•ç¤ºäº†ASTåœ¨å¯„å­˜å™¨ä¸­çš„ä½¿ç”¨
    state.regs.eax = password      # å°†åŸå§‹å¯†ç å­˜å‚¨åˆ°EAX
    state.regs.ebx = check_expr    # å°†è®¡ç®—ç»“æœå­˜å‚¨åˆ°EBX

    print(f"ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹Ÿç¨‹åºæ‰§è¡ŒçŠ¶æ€")
    print(f"  EAX (åŸå§‹å¯†ç ): {state.regs.eax}")
    print(f"  EBX (è®¡ç®—ç»“æœ): {state.regs.ebx}")
    print(f"  è¯´æ˜ï¼šè¿™æ¨¡æ‹Ÿäº†ç¨‹åºåœ¨å†…å­˜ä¸­çš„å®é™…çŠ¶æ€")
    print()

    # ç¬¬å››æ­¥ï¼šæ·»åŠ çº¦æŸæ¡ä»¶
    # è¿™æ˜¯ç¬¦å·æ‰§è¡Œçš„å…³é”®æ­¥éª¤ - å‘Šè¯‰æ±‚è§£å™¨æˆ‘ä»¬çš„ç›®æ ‡
    constraint = state.regs.ebx == target_value
    state.solver.add(constraint)

    print(f"ç¬¬å››æ­¥ï¼šæ·»åŠ çº¦æŸæ¡ä»¶")
    print(f"  çº¦æŸè¡¨è¾¾å¼: {constraint}")
    print(f"  å«ä¹‰: EBXå¯„å­˜å™¨çš„å€¼å¿…é¡»ç­‰äºç›®æ ‡å€¼")
    print(f"  å½±å“: è¿™é™åˆ¶äº†å¯†ç çš„å¯èƒ½å–å€¼èŒƒå›´")
    print()

    # ç¬¬äº”æ­¥ï¼šçº¦æŸæ±‚è§£
    # è¿™æ˜¯ç¥å¥‡çš„éƒ¨åˆ† - angrä¼šè‡ªåŠ¨æ‰¾åˆ°æ»¡è¶³æ‰€æœ‰çº¦æŸçš„å…·ä½“å€¼
    print(f"ç¬¬äº”æ­¥ï¼šå¼€å§‹çº¦æŸæ±‚è§£")
    print("  æ±‚è§£å™¨æ­£åœ¨åˆ†æçº¦æŸæ¡ä»¶...")
    print()

    if state.solver.satisfiable():
        # å¦‚æœçº¦æŸå¯æ»¡è¶³ï¼Œè·å–ä¸€ä¸ªå…·ä½“çš„è§£
        solution = state.solver.eval(password)

        print(f"âœ“ çº¦æŸå¯æ»¡è¶³ï¼")
        print(f"  æ‰¾åˆ°çš„è§£: password = 0x{solution:x} ({solution})")
        print()

        # ç¬¬å…­æ­¥ï¼šéªŒè¯è§£çš„æ­£ç¡®æ€§
        print(f"ç¬¬å…­æ­¥ï¼šéªŒè¯è§£çš„æ­£ç¡®æ€§")
        verification = solution * 1337 + 42
        print(f"  éªŒè¯è®¡ç®—: {solution} * 1337 + 42 = 0x{verification:x}")
        print(f"  ç›®æ ‡å€¼:   0x{target_value:x}")
        print(f"  åŒ¹é…ç»“æœ: {'âœ“ æ­£ç¡®' if verification == target_value else 'âœ— é”™è¯¯'}")
        print()

        print("çº¦æŸæ±‚è§£æˆåŠŸçš„å…³é”®å› ç´ ï¼š")
        print("1. çº¿æ€§æ–¹ç¨‹ï¼šæˆ‘ä»¬æ„é€ çš„æ˜¯ä¸€ä¸ªç®€å•çš„çº¿æ€§æ–¹ç¨‹")
        print("2. å”¯ä¸€è§£ï¼šå¯¹äº32ä½æ•´æ•°ï¼Œè¿™ä¸ªæ–¹ç¨‹æœ‰å”¯ä¸€è§£")
        print("3. æ±‚è§£èƒ½åŠ›ï¼šangrçš„çº¦æŸæ±‚è§£å™¨èƒ½å¤Ÿå¤„ç†å„ç§æ•°å­¦è¿ç®—")
        print()

        print("å®é™…åº”ç”¨åœºæ™¯ï¼š")
        print("â€¢ å¯†ç ç ´è§£ï¼šæ‰¾åˆ°æ­£ç¡®çš„å¯†ç æˆ–å¯†é’¥")
        print("â€¢ è·¯å¾„åˆ°è¾¾ï¼šç”Ÿæˆèƒ½å¤Ÿåˆ°è¾¾ç‰¹å®šä»£ç è·¯å¾„çš„è¾“å…¥")
        print("â€¢ æ¼æ´è§¦å‘ï¼šåˆ›å»ºèƒ½å¤Ÿè§¦å‘å®‰å…¨æ¼æ´çš„æ¶æ„è¾“å…¥")
        print("â€¢ é€†å‘å·¥ç¨‹ï¼šç†è§£å¤æ‚ç®—æ³•çš„è¾“å…¥è¾“å‡ºå…³ç³»")

    else:
        # å¦‚æœçº¦æŸä¸å¯æ»¡è¶³
        print(f"âœ— çº¦æŸä¸å¯æ»¡è¶³")
        print("  å¯èƒ½åŸå› ï¼š")
        print("  1. çº¦æŸæ¡ä»¶ç›¸äº’çŸ›ç›¾")
        print("  2. å˜é‡èŒƒå›´é™åˆ¶è¿‡ä¸¥")
        print("  3. æ•°å­¦ä¸Šæ— è§£")
        print()
        print("è¿™åœ¨å®é™…åˆ†æä¸­å¾ˆæœ‰ç”¨ï¼š")
        print("â€¢ è¯æ˜æŸæ®µä»£ç ä¸å¯è¾¾")
        print("â€¢ å‘ç°ç¨‹åºé€»è¾‘é”™è¯¯")
        print("â€¢ éªŒè¯å®‰å…¨é˜²æŠ¤çš„æœ‰æ•ˆæ€§")

    print()
    print("è¿›é˜¶æ¦‚å¿µï¼š")
    print("- å¤šè§£æŸ¥è¯¢ï¼šstate.solver.eval_all(password, max_solutions=10)")
    print("- è§£çš„èŒƒå›´ï¼šstate.solver.min(password), state.solver.max(password)")
    print("- å¤æ‚çº¦æŸï¼šæ”¯æŒä½è¿ç®—ã€æ•°ç»„ã€ç»“æ„ä½“ç­‰")
    print("- ç¬¦å·æ‰§è¡Œï¼šç»“åˆè·¯å¾„æ¢ç´¢è¿›è¡Œæ›´æ·±å…¥çš„åˆ†æ")

def demonstrate_memory_layout():
    """æ¼”ç¤ºå†…å­˜ä¸­ASTçš„å¸ƒå±€

    è¿™ä¸ªå‡½æ•°å±•ç¤ºäº†å¦‚ä½•åœ¨å†…å­˜ä¸­ç»„ç»‡å¤šä¸ªç›¸å…³çš„ASTï¼Œ
    è¿™æ¨¡æ‹Ÿäº†çœŸå®ç¨‹åºä¸­çš„æ•°æ®ç»“æ„ï¼Œå¦‚æ•°ç»„ã€ç»“æ„ä½“ç­‰ã€‚

    å†…å­˜å¸ƒå±€çš„é‡è¦æ€§ï¼š
    1. æ•°æ®ç»“æ„ï¼šç¨‹åºå¦‚ä½•ç»„ç»‡å¤æ‚çš„æ•°æ®
    2. ç¼“å†²åŒºåˆ†æï¼šç†è§£ç¨‹åºçš„è¾“å…¥å¤„ç†
    3. æ´¾ç”Ÿæ•°æ®ï¼šå¦‚ä½•ä»ä¸€ä¸ªåŸºç¡€å€¼ç”Ÿæˆå¤šä¸ªç›¸å…³å€¼

    å®é™…åº”ç”¨åœºæ™¯ï¼š
    - åˆ†æç»“æ„ä½“å­—æ®µçš„ç¬¦å·å…³ç³»
    - ç†è§£æ•°ç»„ä¸­å…ƒç´ çš„å¤„ç†é€»è¾‘
    - è·Ÿè¸ªç¼“å†²åŒºä¸­æ•°æ®çš„æµåŠ¨
    """
    print("\n=== å†…å­˜ä¸­çš„ASTå¸ƒå±€ ===")
    print("æ¼”ç¤ºï¼šåœ¨è¿ç»­å†…å­˜ä¸­ç»„ç»‡ç›¸å…³çš„ç¬¦å·è¡¨è¾¾å¼")
    print()

    proj = angr.Project('/bin/ls')
    state = proj.factory.entry_state()

    print("åœºæ™¯è®¾å®šï¼šæ¨¡æ‹Ÿç¨‹åºå¤„ç†ä¸€ä¸ªæ•°æ®ç»“æ„")
    print("æ•°æ®å…³ç³»ï¼šä»åŸºç¡€å€¼æ´¾ç”Ÿå‡ºå¤šä¸ªç›¸å…³çš„è®¡ç®—ç»“æœ")
    print()

    # ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºåŸºç¡€ç¬¦å·å˜é‡å’Œæ´¾ç”ŸAST
    base = claripy.BVS("base", 32)  # åŸºç¡€è¾“å…¥å€¼

    # åˆ›å»ºä¸€ç»„ç›¸å…³çš„ASTï¼Œæ¨¡æ‹Ÿæ•°æ®ç»“æ„çš„ä¸åŒå­—æ®µ
    asts = {
        'original': base,                           # åŸå§‹å€¼
        'doubled': base * 2,                        # ç¿»å€
        'plus_offset': base + 0x100,                # åŠ åç§»
        'complex': (base * 3 + 0x200) ^ 0xaaaaaaaa  # å¤æ‚å˜æ¢
    }

    print("ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç›¸å…³çš„ç¬¦å·è¡¨è¾¾å¼")
    print("  åŸºç¡€å˜é‡: base")
    print("  æ´¾ç”Ÿè¡¨è¾¾å¼:")
    for name, ast in asts.items():
        print(f"    {name:<12}: {ast}")
    print()

    # ç¬¬äºŒæ­¥ï¼šå°†ASTè¿ç»­å­˜å‚¨åˆ°å†…å­˜ï¼Œæ¨¡æ‹Ÿæ•°æ®ç»“æ„
    base_addr = 0x30000
    print(f"ç¬¬äºŒæ­¥ï¼šå°†ASTå­˜å‚¨åˆ°è¿ç»­å†…å­˜å¸ƒå±€")
    print(f"  èµ·å§‹åœ°å€: 0x{base_addr:x}")
    print(f"  æ•°æ®å¤§å°: æ¯ä¸ª32ä½ï¼Œå…±4ä¸ªå€¼")
    print()

    for i, (name, ast) in enumerate(asts.items()):
        addr = base_addr + i * 4  # æ¯ä¸ª32ä½å€¼å ç”¨4å­—èŠ‚
        state.mem[addr].uint32_t = ast
        print(f"  å­˜å‚¨æ“ä½œ: å†…å­˜[0x{addr:x}] â† {name}")
        print(f"  å†…å®¹:    {ast}")
        print()

    # ç¬¬ä¸‰æ­¥ï¼šä»å†…å­˜è¯»å–å¹¶ç»„åˆï¼Œæ¨¡æ‹Ÿç¨‹åºçš„æ•°æ®å¤„ç†
    print("ç¬¬ä¸‰æ­¥ï¼šä»å†…å­˜è¯»å–å¹¶è¿›è¡Œç»„åˆè®¡ç®—")
    print("  æ¨¡æ‹Ÿç¨‹åºè¯»å–æ•°æ®ç»“æ„å¹¶è®¡ç®—æ–°çš„å€¼")
    print()

    # è¯»å–å‰ä¸‰ä¸ªASTè¿›è¡Œç»„åˆ
    ast1 = state.mem[base_addr].uint32_t.resolved           # è¯»å– base
    ast2 = state.mem[base_addr + 4].uint32_t.resolved       # è¯»å– base*2
    ast3 = state.mem[base_addr + 8].uint32_t.resolved       # è¯»å– base+0x100

    print("  è¯»å–æ“ä½œ:")
    print(f"    ast1 â† å†…å­˜[0x{base_addr:x}]     = {ast1}")
    print(f"    ast2 â† å†…å­˜[0x{base_addr + 4:x}] = {ast2}")
    print(f"    ast3 â† å†…å­˜[0x{base_addr + 8:x}] = {ast3}")
    print()

    # è¿›è¡Œç»„åˆè®¡ç®—ï¼šbase + (base*2) - (base+0x100) = base + 2*base - base - 0x100 = 2*base - 0x100
    combined = ast1 + ast2 - ast3
    result_addr = base_addr + 16  # å°†ç»“æœå­˜å‚¨åœ¨åé¢

    print("  ç»„åˆè®¡ç®—:")
    print(f"    å…¬å¼: ast1 + ast2 - ast3")
    print(f"    å±•å¼€: {ast1} + {ast2} - {ast3}")
    print(f"    ç»“æœ: {combined}")
    print()

    # å­˜å‚¨ç»„åˆç»“æœ
    state.mem[result_addr].uint32_t = combined
    print(f"  å­˜å‚¨ç»“æœ: å†…å­˜[0x{result_addr:x}] â† {combined}")
    print()

    # ç¬¬å››æ­¥ï¼šå†…å­˜å¸ƒå±€æ€»ç»“
    print("ç¬¬å››æ­¥ï¼šå†…å­˜å¸ƒå±€æ€»ç»“")
    print("-" * 50)
    print("åœ°å€åç§» | å†…å®¹æè¿°        | ASTè¡¨è¾¾å¼")
    print("-" * 50)

    layout_info = [
        (0x0, "åŸå§‹å€¼", asts['original']),
        (0x4, "ç¿»å€å€¼", asts['doubled']),
        (0x8, "åç§»å€¼", asts['plus_offset']),
        (0xc, "å¤æ‚å˜æ¢", asts['complex']),
        (0x10, "ç»„åˆç»“æœ", combined)
    ]

    for offset, desc, ast in layout_info:
        addr = base_addr + offset
        print(f"0x{addr:x} | {desc:<14} | {ast}")
    print()

    print("å…³é”®è§‚å¯Ÿç‚¹ï¼š")
    print("1. å†…å­˜å¸ƒå±€å¯ä»¥è¡¨ç¤ºå¤æ‚çš„æ•°æ®å…³ç³»")
    print("2. ç›¸åŒçš„åŸºç¡€å˜é‡å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨")
    print("3. ä»å†…å­˜è¯»å–çš„ASTä¿æŒäº†å®Œæ•´çš„ç¬¦å·ä¿¡æ¯")
    print("4. æ–°çš„è®¡ç®—ç»“æœå¯ä»¥ç»§ç»­å­˜å‚¨å›å†…å­˜")
    print()

    print("å®é™…åº”ç”¨ä»·å€¼ï¼š")
    print("âœ“ åˆ†æç¨‹åºä¸­çš„æ•°æ®ç»“æ„å’Œæ•°ç»„")
    print("âœ“ ç†è§£ç¼“å†²åŒºæº¢å‡ºå’Œå†…å­˜æ¼æ´")
    print("âœ“ è·Ÿè¸ªå¤æ‚ç®—æ³•çš„ä¸­é—´è®¡ç®—æ­¥éª¤")
    print("âœ“ é€†å‘åˆ†æç¨‹åºçš„æ•°æ®å¤„ç†é€»è¾‘")
    print("âœ“ ç”Ÿæˆé’ˆå¯¹ç‰¹å®šå†…å­˜å¸ƒå±€çš„æµ‹è¯•è¾“å…¥")

def main():
    """ä¸»å‡½æ•° - ASTå­˜å‚¨æœºåˆ¶ç»¼åˆæ¼”ç¤º

    é€šè¿‡è¿™ä¸ªç»¼åˆæ¼”ç¤ºï¼Œå­¦ä¹ è€…å°†æ·±å…¥ç†è§£angrä¸­ASTå­˜å‚¨æœºåˆ¶çš„æ ¸å¿ƒæ¦‚å¿µï¼Œ
    ä¸ºåç»­çš„ç¬¦å·æ‰§è¡Œå’ŒäºŒè¿›åˆ¶åˆ†ææ‰“ä¸‹åšå®åŸºç¡€ã€‚

    å­¦ä¹ è·¯å¾„å»ºè®®ï¼š
    1. å…ˆç†è§£ASTçš„åŸºæœ¬æ¦‚å¿µï¼ˆç¬¬ä¸€éƒ¨åˆ†ï¼‰
    2. æŒæ¡å­˜å‚¨æœºåˆ¶ï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰
    3. å­¦ä¹ æ“ä½œå’Œçº¦æŸæ±‚è§£ï¼ˆç¬¬ä¸‰ã€å››éƒ¨åˆ†ï¼‰
    4. å®è·µå†…å­˜å¸ƒå±€åˆ†æï¼ˆç¬¬äº”éƒ¨åˆ†ï¼‰
    5. å®Œæˆangr CTFç›¸å…³æŒ‘æˆ˜
    """
    print("=== æ·±å…¥ç†è§£angr ASTå­˜å‚¨æœºåˆ¶ ===")
    print("æ ¸å¿ƒæ¦‚å¿µï¼š'any bitvector-typed AST can be stored in registers or memory'")
    print("=" * 70)
    print()

    # æ‰§è¡Œæ‰€æœ‰æ¼”ç¤ºå‡½æ•°
    print("å¼€å§‹æ¼”ç¤ºï¼Œè¯·ä»”ç»†è§‚å¯Ÿæ¯ä¸ªéƒ¨åˆ†çš„è¾“å‡º...")
    print()

    try:
        demonstrate_ast_tree_structure()
        input("æŒ‰Enteré”®ç»§ç»­åˆ°ä¸‹ä¸€éƒ¨åˆ†...")
        print()

        demonstrate_storage_equivalence()
        input("æŒ‰Enteré”®ç»§ç»­åˆ°ä¸‹ä¸€éƒ¨åˆ†...")
        print()

        demonstrate_ast_operations_storage()
        input("æŒ‰Enteré”®ç»§ç»­åˆ°ä¸‹ä¸€éƒ¨åˆ†...")
        print()

        demonstrate_constraint_solving()
        input("æŒ‰Enteré”®ç»§ç»­åˆ°ä¸‹ä¸€éƒ¨åˆ†...")
        print()

        demonstrate_memory_layout()

    except KeyboardInterrupt:
        print("\næ¼”ç¤ºè¢«ç”¨æˆ·ä¸­æ–­")
        return
    except Exception as e:
        print(f"\næ¼”ç¤ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        print("è¿™å¯èƒ½æ˜¯ç”±äºç³»ç»Ÿç¯å¢ƒé—®é¢˜ï¼Œè¯·æ£€æŸ¥angræ˜¯å¦æ­£ç¡®å®‰è£…")

    # æ‰“å°ç»¼åˆæ€»ç»“
    print("\n" + "=" * 70)
    print("=== ç»¼åˆå­¦ä¹ æ€»ç»“ä¸å…³é”®è¦ç‚¹ ===")
    print("=" * 70)

    print("\nğŸ“š æ ¸å¿ƒæ¦‚å¿µç†è§£ï¼š")
    print("1. ASTçš„æœ¬è´¨ï¼š")
    print("   âœ“ ASTä¸æ˜¯å…·ä½“æ•°å€¼ï¼Œè€Œæ˜¯è®¡ç®—çš„æŠ½è±¡æè¿°")
    print("   âœ“ å¯ä»¥è¡¨ç¤ºä»»æ„å¤æ‚çš„æ•°å­¦å’Œé€»è¾‘è¡¨è¾¾å¼")
    print("   âœ“ åœ¨ç¬¦å·æ‰§è¡Œä¸­ä»£è¡¨æ‰€æœ‰å¯èƒ½çš„è®¡ç®—è·¯å¾„")

    print("\n2. å­˜å‚¨æœºåˆ¶çš„çµæ´»æ€§ï¼š")
    print("   âœ“ ä»»ä½•bitvectorç±»å‹çš„ASTéƒ½å¯ä»¥å­˜å‚¨åœ¨å¯„å­˜å™¨æˆ–å†…å­˜ä¸­")
    print("   âœ“ å­˜å‚¨ä½ç½®ä¸å½±å“ASTçš„ç¬¦å·è¯­ä¹‰å’Œè¡¨è¾¾èƒ½åŠ›")
    print("   âœ“ ASTå¯ä»¥åœ¨ä¸åŒå­˜å‚¨ä½ç½®é—´è‡ªç”±ç§»åŠ¨è€Œä¿æŒå®Œæ•´æ€§")

    print("\n3. æ“ä½œçš„é“¾å¼ç»„åˆï¼š")
    print("   âœ“ å¯ä»¥ä»å­˜å‚¨ä½ç½®è¯»å–ASTå¹¶è¿›è¡Œè¿›ä¸€æ­¥æ“ä½œ")
    print("   âœ“ æ¯æ¬¡æ“ä½œéƒ½ä¼šæ‰©å±•ASTçš„å¤æ‚åº¦å’Œè¡¨è¾¾èƒ½åŠ›")
    print("   âœ“ æœ€ç»ˆçš„ASTåŒ…å«äº†å®Œæ•´çš„æ•°æ®å¤„ç†å†å²")

    print("\n4. çº¦æŸæ±‚è§£çš„å¨åŠ›ï¼š")
    print("   âœ“ èƒ½å¤Ÿä»æœŸæœ›çš„è¾“å‡ºåå‘æ¨å¯¼æ‰€éœ€çš„è¾“å…¥")
    print("   âœ“ æ”¯æŒå¤æ‚çš„æ•°å­¦è¿ç®—å’Œé€»è¾‘æ¡ä»¶")
    print("   âœ“ æ˜¯è‡ªåŠ¨åŒ–æ¼æ´åˆ†æå’Œé€†å‘å·¥ç¨‹çš„æ ¸å¿ƒå·¥å…·")

    print("\nğŸ¯ å®é™…åº”ç”¨æŠ€èƒ½ï¼š")
    print("1. ç¨‹åºåˆ†æèƒ½åŠ›ï¼š")
    print("   â€¢ è·Ÿè¸ªç”¨æˆ·è¾“å…¥åœ¨ç¨‹åºä¸­çš„å®Œæ•´å¤„ç†æµç¨‹")
    print("   â€¢ ç†è§£å¤æ‚ç®—æ³•çš„æ¯ä¸€æ­¥å˜æ¢å’Œæ•°æ®æµ")
    print("   â€¢ åˆ†æåŠ å¯†ã€å‹ç¼©ã€ç¼–ç ç­‰æ•°æ®å¤„ç†é€»è¾‘")

    print("\n2. æ¼æ´åˆ†ææŠ€æœ¯ï¼š")
    print("   â€¢ ç”Ÿæˆè§¦å‘ç‰¹å®šç¨‹åºè¡Œä¸ºçš„æµ‹è¯•è¾“å…¥")
    print("   â€¢ åˆ†æç¼“å†²åŒºæº¢å‡ºå’Œå†…å­˜å®‰å…¨é—®é¢˜")
    print("   â€¢ éªŒè¯ç¨‹åºçš„å®‰å…¨é˜²æŠ¤æœºåˆ¶")

    print("\n3. é€†å‘å·¥ç¨‹æ–¹æ³•ï¼š")
    print("   â€¢ ç†è§£ä¸“æœ‰æ–‡ä»¶æ ¼å¼å’Œç½‘ç»œåè®®")
    print("   â€¢ åˆ†ææ¶æ„è½¯ä»¶çš„é€šä¿¡å’ŒåŠ å¯†æœºåˆ¶")
    print("   â€¢ æ¢å¤ä¸¢å¤±çš„ç®—æ³•æ–‡æ¡£å’Œå®ç°ç»†èŠ‚")

    print("\nğŸš€ åç»­å­¦ä¹ è·¯å¾„ï¼š")
    print("1. ç«‹å³å®è·µï¼š")
    print("   â€¢ å®Œæˆangr CTFæŒ‘æˆ˜03-06ï¼ˆç¬¦å·æ“ä½œç³»åˆ—ï¼‰")
    print("   â€¢ å°è¯•ä¿®æ”¹æœ¬æ•™ç¨‹ä¸­çš„ç¤ºä¾‹ä»£ç ")
    print("   â€¢ ç”¨angråˆ†æç®€å•çš„Cç¨‹åº")

    print("\n2. è¿›é˜¶ä¸»é¢˜ï¼š")
    print("   â€¢ å­¦ä¹ è·¯å¾„æ¢ç´¢å’ŒçŠ¶æ€ç®¡ç†")
    print("   â€¢ æŒæ¡HookæŠ€æœ¯å’Œè‡ªå®šä¹‰æ¨¡æ‹Ÿ")
    print("   â€¢ ç ”ç©¶åŠ¨æ€å†…å­˜å’Œå¤æ‚æ•°æ®ç»“æ„")

    print("\n3. é«˜çº§åº”ç”¨ï¼š")
    print("   â€¢ è‡ªåŠ¨åŒ–æ¼æ´æŒ–æ˜æ¡†æ¶å¼€å‘")
    print("   â€¢ å¤§è§„æ¨¡äºŒè¿›åˆ¶åˆ†æå¹³å°æ„å»º")
    print("   â€¢ AIè¾…åŠ©çš„é€†å‘å·¥ç¨‹å·¥å…·è®¾è®¡")

    print("\nğŸ’¡ å­¦ä¹ å»ºè®®ï¼š")
    print("â€¢ åŠ¨æ‰‹å®è·µï¼šç†è®ºç†è§£åç«‹å³ç¼–å†™ä»£ç éªŒè¯")
    print("â€¢ å¾ªåºæ¸è¿›ï¼šä»ç®€å•ç¤ºä¾‹å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚åº¦")
    print("â€¢ è”ç³»å®é™…ï¼šå°†æ¦‚å¿µåº”ç”¨åˆ°çœŸå®çš„ç¨‹åºåˆ†æä¸­")
    print("â€¢ æŒç»­æ¢ç´¢ï¼šangråŠŸèƒ½ä¸°å¯Œï¼Œä¿æŒå­¦ä¹ çš„çƒ­æƒ…")

    print("\n" + "=" * 70)
    print("ğŸ‰ æ­å–œï¼æ‚¨å·²ç»æŒæ¡äº†angr ASTå­˜å‚¨æœºåˆ¶çš„æ ¸å¿ƒæ¦‚å¿µ")
    print("ç»§ç»­æ¢ç´¢ç¬¦å·æ‰§è¡Œçš„ç²¾å½©ä¸–ç•Œå§ï¼")
    print("=" * 70)

if __name__ == "__main__":
    main()